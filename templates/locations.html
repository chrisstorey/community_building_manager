{% extends "base.html" %}

{% block title %}Locations - Community Building Manager{% endblock %}

{% block content %}
<div class="locations-container">
    <h1>Locations</h1>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <div>
            <p style="color: var(--text-light); margin: 0;">Manage your community building locations</p>
        </div>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <input type="text" id="search-locations" placeholder="Search locations..." style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; width: 200px;">
            <select id="status-filter" style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="under_maintenance">Under Maintenance</option>
            </select>
            <button class="btn btn-action" id="add-location-btn">+ Add Location</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>All Locations</h3>
        </div>
        <div id="locations-list">
            <p style="text-align: center; color: var(--text-light);">Loading locations...</p>
        </div>
    </div>
</div>

<!-- Add/Edit Location Modal -->
<div id="location-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h2 id="modal-title">Add Location</h2>
        <form id="location-form">
            <div style="margin-bottom: 1rem;">
                <label for="location-name">Name *</label>
                <input type="text" id="location-name" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="location-address">Address *</label>
                <input type="text" id="location-address" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label for="location-latitude">Latitude</label>
                    <input type="number" id="location-latitude" step="0.000001" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label for="location-longitude">Longitude</label>
                    <input type="number" id="location-longitude" step="0.000001" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="location-status">Status</label>
                <select id="location-status" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="under_maintenance">Under Maintenance</option>
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="location-hours">Opening Hours</label>
                <input type="text" id="location-hours" placeholder="e.g., Mon-Fri 09:00-17:00; Sat 10:00-14:00" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label for="location-capacity">Capacity</label>
                    <input type="number" id="location-capacity" min="0" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label for="location-contact">Contact Person</label>
                    <input type="text" id="location-contact" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label for="location-phone">Phone</label>
                    <input type="tel" id="location-phone" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label for="location-email">Email</label>
                    <input type="email" id="location-email" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-action">Save Location</button>
                <button type="button" class="btn btn-outline" onclick="closeLocationModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Location Details Modal -->
<div id="location-details-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h2 id="details-title">Location Details</h2>
        <div id="location-details-content"></div>
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button class="btn btn-action" id="edit-location-btn">Edit</button>
            <button class="btn btn-outline" id="delete-location-btn" style="border-color: #dc3545; color: #dc3545;">Delete</button>
            <button class="btn btn-outline" onclick="closeDetailsModal()">Close</button>
        </div>
    </div>
</div>

<script>
    let currentUserId = null;
    let currentUserOrgId = null;
    let currentLocationId = null;

    async function loadLocations() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        try {
            currentUserOrgId = await getCurrentUserOrgId();
            const response = await fetch(`/organizations/${currentUserOrgId}/locations`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const locations = await response.json();
            displayLocations(locations);
        } catch (error) {
            console.error('Error loading locations:', error);
            document.getElementById('locations-list').innerHTML = `<div class="alert alert-danger">Error loading locations. Please refresh the page.</div>`;
        }
    }

    async function getCurrentUserOrgId() {
        const token = localStorage.getItem('access_token');
        const resp = await fetch('/auth/me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const user = await resp.json();
        currentUserId = user.id;
        return user.organization_id;
    }

    async function searchLocations() {
        const token = localStorage.getItem('access_token');
        const query = document.getElementById('search-locations').value;
        const status = document.getElementById('status-filter').value;

        try {
            let url = '/organizations/locations/search?';
            if (query) url += `q=${encodeURIComponent(query)}&`;
            if (status) url += `status_filter=${encodeURIComponent(status)}&`;
            if (currentUserOrgId) url += `org_id=${currentUserOrgId}`;

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const locations = await response.json();
            displayLocations(locations);
        } catch (error) {
            console.error('Error searching locations:', error);
        }
    }

    function displayLocations(locations) {
        const container = document.getElementById('locations-list');
        if (locations.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No locations found. Click "Add Location" to get started.</p>';
            return;
        }

        let html = '<table class="table">';
        html += '<thead><tr><th>Name</th><th>Address</th><th>Status</th><th>Contact</th><th>Actions</th></tr></thead><tbody>';
        locations.forEach(location => {
            const statusBadge = `<span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; background-color: ${
                location.status === 'active' ? '#059669' :
                location.status === 'inactive' ? '#9ca3af' :
                '#f97316'
            }; color: white;">${location.status}</span>`;

            html += `<tr>
                <td><strong>${location.name}</strong></td>
                <td>${location.address || 'N/A'}</td>
                <td>${statusBadge}</td>
                <td>${location.contact_person || 'N/A'}</td>
                <td>
                    <button class="btn btn-outline" style="font-size: 0.85rem; padding: 0.25rem 0.5rem;" onclick="viewLocationDetails(${location.id})">View</button>
                    <button class="btn btn-outline" style="font-size: 0.85rem; padding: 0.25rem 0.5rem;" onclick="editLocation(${location.id})">Edit</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    async function viewLocationDetails(locationId) {
        const token = localStorage.getItem('access_token');
        try {
            const response = await fetch(`/organizations/locations/${locationId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const location = await response.json();
            currentLocationId = location.id;

            let detailsHtml = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="margin-bottom: 1rem;">
                        <h4>Name</h4>
                        <p>${location.name}</p>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <h4>Address</h4>
                        <p>${location.address}</p>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <h4>Status</h4>
                        <p>${location.status}</p>
                    </div>
                    ${location.latitude ? `<div style="margin-bottom: 1rem;">
                        <h4>Location</h4>
                        <p>Latitude: ${location.latitude}, Longitude: ${location.longitude}</p>
                    </div>` : ''}
                    ${location.opening_hours ? `<div style="margin-bottom: 1rem;">
                        <h4>Opening Hours</h4>
                        <p>${location.opening_hours}</p>
                    </div>` : ''}
                    ${location.capacity ? `<div style="margin-bottom: 1rem;">
                        <h4>Capacity</h4>
                        <p>${location.capacity} people</p>
                    </div>` : ''}
                    ${location.contact_person ? `<div style="margin-bottom: 1rem;">
                        <h4>Contact Person</h4>
                        <p>${location.contact_person}</p>
                    </div>` : ''}
                    ${location.contact_phone ? `<div style="margin-bottom: 1rem;">
                        <h4>Phone</h4>
                        <p>${location.contact_phone}</p>
                    </div>` : ''}
                    ${location.contact_email ? `<div style="margin-bottom: 1rem;">
                        <h4>Email</h4>
                        <p>${location.contact_email}</p>
                    </div>` : ''}
                    <div style="margin-bottom: 1rem;">
                        <h4>Created</h4>
                        <p>${new Date(location.created_at).toLocaleDateString()}</p>
                    </div>
                </div>
            `;

            document.getElementById('location-details-content').innerHTML = detailsHtml;
            document.getElementById('details-title').textContent = location.name;
            document.getElementById('location-details-modal').style.display = 'block';
        } catch (error) {
            console.error('Error loading location details:', error);
            alert('Error loading location details');
        }
    }

    async function editLocation(locationId) {
        const token = localStorage.getItem('access_token');
        try {
            const response = await fetch(`/organizations/locations/${locationId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const location = await response.json();
            currentLocationId = location.id;

            document.getElementById('modal-title').textContent = 'Edit Location';
            document.getElementById('location-name').value = location.name;
            document.getElementById('location-address').value = location.address;
            document.getElementById('location-latitude').value = location.latitude || '';
            document.getElementById('location-longitude').value = location.longitude || '';
            document.getElementById('location-status').value = location.status;
            document.getElementById('location-hours').value = location.opening_hours || '';
            document.getElementById('location-capacity').value = location.capacity || '';
            document.getElementById('location-contact').value = location.contact_person || '';
            document.getElementById('location-phone').value = location.contact_phone || '';
            document.getElementById('location-email').value = location.contact_email || '';

            closeDetailsModal();
            document.getElementById('location-modal').style.display = 'block';
        } catch (error) {
            console.error('Error loading location:', error);
            alert('Error loading location');
        }
    }

    async function saveLocation(e) {
        e.preventDefault();
        const token = localStorage.getItem('access_token');

        const locationData = {
            name: document.getElementById('location-name').value,
            address: document.getElementById('location-address').value,
            latitude: document.getElementById('location-latitude').value ? parseFloat(document.getElementById('location-latitude').value) : null,
            longitude: document.getElementById('location-longitude').value ? parseFloat(document.getElementById('location-longitude').value) : null,
            status: document.getElementById('location-status').value,
            opening_hours: document.getElementById('location-hours').value || null,
            capacity: document.getElementById('location-capacity').value ? parseInt(document.getElementById('location-capacity').value) : null,
            contact_person: document.getElementById('location-contact').value || null,
            contact_phone: document.getElementById('location-phone').value || null,
            contact_email: document.getElementById('location-email').value || null,
        };

        try {
            const method = currentLocationId ? 'PATCH' : 'POST';
            const url = currentLocationId
                ? `/organizations/locations/${currentLocationId}`
                : `/organizations/${currentUserOrgId}/locations`;

            if (!currentLocationId) {
                locationData.organization_id = currentUserOrgId;
            }

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(locationData)
            });

            if (!response.ok) {
                throw new Error('Failed to save location');
            }

            closeLocationModal();
            await loadLocations();
            alert('Location saved successfully!');
        } catch (error) {
            console.error('Error saving location:', error);
            alert('Error saving location: ' + error.message);
        }
    }

    async function deleteCurrentLocation() {
        const token = localStorage.getItem('access_token');
        if (!currentLocationId || !confirm('Are you sure you want to delete this location?')) return;

        try {
            const response = await fetch(`/organizations/locations/${currentLocationId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                throw new Error('Failed to delete location');
            }

            closeDetailsModal();
            await loadLocations();
            alert('Location deleted successfully!');
        } catch (error) {
            console.error('Error deleting location:', error);
            alert('Error deleting location: ' + error.message);
        }
    }

    function closeLocationModal() {
        document.getElementById('location-modal').style.display = 'none';
        document.getElementById('modal-title').textContent = 'Add Location';
        document.getElementById('location-form').reset();
        currentLocationId = null;
    }

    function closeDetailsModal() {
        document.getElementById('location-details-modal').style.display = 'none';
        currentLocationId = null;
    }

    // Event listeners
    document.getElementById('add-location-btn').addEventListener('click', () => {
        currentLocationId = null;
        document.getElementById('location-form').reset();
        document.getElementById('modal-title').textContent = 'Add Location';
        document.getElementById('location-modal').style.display = 'block';
    });

    document.getElementById('location-form').addEventListener('submit', saveLocation);

    document.getElementById('search-locations').addEventListener('input', searchLocations);
    document.getElementById('status-filter').addEventListener('change', searchLocations);

    document.getElementById('delete-location-btn').addEventListener('click', deleteCurrentLocation);

    window.addEventListener('load', loadLocations);
</script>
{% endblock %}
